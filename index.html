<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa RJ - Reciclagem de Lixo Eletrônico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 100%; width: 100%; }
        .marker-cluster-small { background-color: rgba(110, 204, 57, 0.6); }
        .marker-cluster-small div { background-color: rgba(110, 204, 57, 0.6); }
        .marker-cluster-medium { background-color: rgba(240, 194, 12, 0.6); }
        .marker-cluster-medium div { background-color: rgba(240, 194, 12, 0.6); }
        .marker-cluster-large { background-color: rgba(241, 128, 23, 0.6); }
        .marker-cluster-large div { background-color: rgba(241, 128, 23, 0.6); }
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
        }
        .leaflet-popup-content {
            margin: 8px 12px;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="min-h-screen grid grid-cols-1 md:grid-cols-5">
        <!-- Sidebar -->
        <aside class="md:col-span-2 p-4 md:p-6 space-y-4 bg-white shadow-md">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Mapa RJ — Reciclagem de Lixo Eletrônico</h1>
                <p class="text-sm text-gray-600 mt-2">Encontre pontos de entrega voluntária (PEVs) e ecopontos para descartar eletrônicos com segurança.</p>
            </div>

            <div class="flex flex-col md:flex-row gap-2">
                <div class="relative flex-grow">
                    <input
                        id="search-input"
                        type="text"
                        placeholder="Buscar por bairro, nome, endereço..."
                        class="w-full rounded-2xl border border-gray-300 p-3 pl-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                    <svg class="absolute left-3 top-3.5 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <select
                    id="category-select"
                    class="rounded-2xl border border-gray-300 p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                    <option value="Todos">Todos</option>
                    <option value="PEV">PEV</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Instituição">Instituição</option>
                    <option value="Sesc">Sesc</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>

            <div id="places-list" class="space-y-3 max-h-[50vh] overflow-auto pr-2 custom-scrollbar">
                <!-- Places will be inserted here by JavaScript -->
            </div>

            <div class="pt-2 text-xs text-gray-500">
                Fonte dos endereços: Portal 1746, Green Eletron, Sesc RJ, publicações de shoppings e instituições. Verifique horários e restrições antes de ir.
            </div>
        </aside>

        <!-- Map -->
        <main class="md:col-span-3 relative">
            <div id="map" class="h-[50vh] md:h-screen w-full"></div>

            <!-- Add Point Widget -->
            <div id="add-point-widget" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur rounded-2xl shadow-lg p-3 flex flex-col gap-2 w-[95%] md:w-[70%]">
                <button id="toggle-add-form" class="rounded-xl px-3 py-2 border border-gray-300 hover:bg-gray-50 text-sm font-medium flex items-center gap-2 justify-center">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Adicionar novo ponto (endereço)
                </button>
                
                <form id="add-point-form" class="hidden grid-cols-1 md:grid-cols-6 gap-2 items-end">
                    <div class="md:col-span-2">
                        <input
                            id="point-name"
                            class="w-full rounded-xl border border-gray-300 p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Nome do ponto"
                            required
                        >
                    </div>
                    <div class="md:col-span-3">
                        <input
                            id="point-address"
                            class="w-full rounded-xl border border-gray-300 p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Endereço completo (RJ)"
                            required
                        >
                    </div>
                    <select
                        id="point-category"
                        class="rounded-xl border border-gray-300 p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="PEV">PEV</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Instituição">Instituição</option>
                        <option value="Sesc">Sesc</option>
                        <option value="Outro" selected>Outro</option>
                    </select>
                    <button type="submit" class="md:col-span-6 rounded-xl px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-colors">
                        Salvar ponto
                    </button>
                </form>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Seed data
        const SEED_PLACES = [
            {
                id: "riosul-ecoponto",
                name: "Ecoponto RIOSUL (G4)",
                category: "Shopping",
                address: "Shopping RIOSUL, Rua Lauro Müller 116, Botafogo, Rio de Janeiro - RJ",
                hours: "Diariamente (horário do shopping)",
                infoUrl: "https://www.instagram.com/p/C5n0DpVunsp/",
                lat: -22.9462,
                lng: -43.1804
            },
            {
                id: "nova-america-coleta",
                name: "Coleta Seletiva — Shopping Nova América",
                category: "Shopping",
                address: "Shopping Nova América, Av. Pastor Martin Luther King Jr, 126 - Del Castilho, Rio de Janeiro - RJ",
                infoUrl: "https://www.novaamerica.com.br/projeto/coleta-seletiva",
                lat: -22.8769,
                lng: -43.2648
            },
            {
                id: "pev-tijuca",
                name: "PEV Tijuca — Resíduos (inclui e-lixo)",
                category: "PEV",
                address: "Rua Dr. Renato Rocco, 400 - Tijuca, Rio de Janeiro - RJ",
                infoUrl: "https://www.1746.rio/hc/pt-br/articles/10734710270747-Informações-sobre-os-postos-de-entrega-voluntária-de-materiais",
                lat: -22.9286,
                lng: -43.2343
            },
            {
                id: "pev-penha",
                name: "PEV Penha — Resíduos (inclui e-lixo)",
                category: "PEV",
                address: "Rua Merindiba, s/n - Penha, Rio de Janeiro - RJ",
                infoUrl: "https://www.1746.rio/hc/pt-br/articles/10734710270747-Informações-sobre-os-postos-de-entrega-voluntária-de-materiais",
                lat: -22.8436,
                lng: -43.2835
            },
            {
                id: "pev-bangu",
                name: "PEV Bangu — Resíduos (inclui e-lixo)",
                category: "PEV",
                address: "Rua Roque Barbosa, 348 - Vila Catiri, Bangu, Rio de Janeiro - RJ",
                infoUrl: "https://www.1746.rio/hc/pt-br/articles/10734710270747-Informações-sobre-os-postos-de-entrega-voluntária-de-materiais",
                lat: -22.8833,
                lng: -43.4719
            },
            {
                id: "real-grandeza",
                name: "Ponto de Coleta — Real Grandeza (Botafogo)",
                category: "Instituição",
                address: "Rua Mena Barreto, 143 - Botafogo, Rio de Janeiro - RJ",
                infoUrl: "https://www.frg.com.br/quem-somos/comunicacao-e-informativos/novidades-e-destaques/real-grandeza-possui-ponto-de-coleta-de-lixo-eletronico-7424.html",
                lat: -22.9508,
                lng: -43.1869
            },
            {
                id: "freguesia-ecoponto",
                name: "Ecoponto Eletrônicos — Freguesia (Jacarepaguá)",
                category: "Shopping",
                address: "Estrada dos Três Rios, 200 - Freguesia, Rio de Janeiro - RJ",
                infoUrl: "https://diariodorio.com/freguesia-na-zona-oeste-do-rio-recebe-ecoponto-para-descarte-de-eletronicos/",
                lat: -22.9394,
                lng: -43.3472
            },
            {
                id: "sesc-copacabana",
                name: "Sesc Copacabana — Ponto de E-lixo",
                category: "Sesc",
                address: "Sesc Copacabana, Rio de Janeiro - RJ",
                infoUrl: "https://www.sescrio.org.br/noticias/sustentabilidade/lixo-eletronico-10-unidades-do-sesc-rj-passam-a-ser-ponto-de-entrega-de-eletroeletronicos/",
                lat: -22.9714,
                lng: -43.1826
            }
        ];

        // App state
        let state = {
            places: [],
            filteredPlaces: [],
            activePlace: null,
            loadingIds: [],
            map: null,
            markers: {}
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            initMap();
            
            // Load places
            loadPlaces();
            
            // Set up event listeners
            setupEventListeners();
        });

        function initMap() {
            // Default center (Rio de Janeiro)
            const center = [-22.9068, -43.1729];
            
            // Create map
            state.map = L.map('map').setView(center, 12);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(state.map);
            
            // Fix marker icons
            delete L.Icon.Default.prototype._getIconUrl;
            L.Icon.Default.mergeOptions({
                iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
                iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
            });
        }

        function loadPlaces() {
            // Load from localStorage if available
            const userPlaces = JSON.parse(localStorage.getItem('user:places') || '[]');
            state.places = [...userPlaces, ...SEED_PLACES];
            
            // Filter places
            filterPlaces();
            
            // Render places list
            renderPlacesList();
            
            // Add markers to map
            addMarkersToMap();
        }

        function filterPlaces() {
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            const categorySelect = document.getElementById('category-select').value;
            
            state.filteredPlaces = state.places.filter(place => {
                const matchesSearch = 
                    place.name.toLowerCase().includes(searchInput) || 
                    place.address.toLowerCase().includes(searchInput);
                
                const matchesCategory = 
                    categorySelect === 'Todos' || 
                    place.category === categorySelect;
                
                return matchesSearch && matchesCategory;
            });
        }

        function renderPlacesList() {
            const placesList = document.getElementById('places-list');
            placesList.innerHTML = '';
            
            if (state.filteredPlaces.length === 0) {
                placesList.innerHTML = '<div class="text-sm text-gray-500 p-3 text-center">Nenhum ponto encontrado para esse filtro.</div>';
                return;
            }
            
            state.filteredPlaces.forEach(place => {
                const placeElement = document.createElement('button');
                placeElement.className = `w-full text-left rounded-2xl p-3 border border-gray-200 hover:shadow-md transition-all ${
                    state.activePlace?.id === place.id ? 'ring-2 ring-blue-500 bg-blue-50' : 'bg-white'
                }`;
                placeElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-semibold text-gray-800">${place.name}</div>
                            <div class="text-sm text-gray-600 mt-1">${place.address}</div>
                            ${place.hours ? `<div class="text-xs text-gray-500 mt-2 flex items-center gap-1">
                                <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                ${place.hours}
                            </div>` : ''}
                        </div>
                        <span class="text-xs font-medium rounded-full px-2 py-1 ${
                            place.category === 'PEV' ? 'bg-green-100 text-green-800' :
                            place.category === 'Shopping' ? 'bg-purple-100 text-purple-800' :
                            place.category === 'Instituição' ? 'bg-blue-100 text-blue-800' :
                            place.category === 'Sesc' ? 'bg-red-100 text-red-800' :
                            'bg-gray-100 text-gray-800'
                        }">${place.category}</span>
                    </div>
                    ${place.infoUrl ? `<a href="${place.infoUrl}" target="_blank" rel="noopener noreferrer" class="text-xs text-blue-600 hover:text-blue-800 underline mt-2 inline-block">
                        Mais informações ↗
                    </a>` : ''}
                    ${state.loadingIds.includes(place.id) ? `<div class="text-xs text-gray-500 mt-2 flex items-center gap-1">
                        <svg class="animate-spin h-3 w-3 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Localizando no mapa…
                    </div>` : ''}
                `;
                
                placeElement.addEventListener('click', () => {
                    setActivePlace(place);
                });
                
                placesList.appendChild(placeElement);
            });
        }

        function addMarkersToMap() {
            // Clear existing markers
            Object.values(state.markers).forEach(marker => {
                state.map.removeLayer(marker);
            });
            state.markers = {};
            
            // Add new markers
            state.filteredPlaces.forEach(place => {
                if (place.lat && place.lng) {
                    const marker = L.marker([place.lat, place.lng]).addTo(state.map);
                    
                    // Add popup
                    marker.bindPopup(`
                        <div class="space-y-1">
                            <div class="font-semibold text-gray-800">${place.name}</div>
                            <div class="text-sm text-gray-600">${place.address}</div>
                            ${place.hours ? `<div class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                                <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                ${place.hours}
                            </div>` : ''}
                            ${place.infoUrl ? `<a href="${place.infoUrl}" target="_blank" rel="noopener noreferrer" class="text-xs text-blue-600 hover:text-blue-800 underline mt-1 inline-block">
                                Detalhes ↗
                            </a>` : ''}
                        </div>
                    `);
                    
                    // Store marker reference
                    state.markers[place.id] = marker;
                    
                    // Add click event
                    marker.on('click', () => {
                        setActivePlace(place);
                    });
                }
            });
        }

        function setActivePlace(place) {
            state.activePlace = place;
            
            // Update UI
            renderPlacesList();
            
            // Fly to location if coordinates exist
            if (place.lat && place.lng) {
                state.map.flyTo([place.lat, place.lng], 14, {
                    duration: 0.8
                });
                
                // Open popup
                if (state.markers[place.id]) {
                    state.markers[place.id].openPopup();
                }
            }
        }

        function setupEventListeners() {
            // Search input
            document.getElementById('search-input').addEventListener('input', () => {
                filterPlaces();
                renderPlacesList();
                addMarkersToMap();
            });
            
            // Category select
            document.getElementById('category-select').addEventListener('change', () => {
                filterPlaces();
                renderPlacesList();
                addMarkersToMap();
            });
            
            // Add point form toggle
            document.getElementById('toggle-add-form').addEventListener('click', () => {
                const form = document.getElementById('add-point-form');
                const button = document.getElementById('toggle-add-form');
                
                if (form.classList.contains('hidden')) {
                    form.classList.remove('hidden');
                    form.classList.add('grid');
                    button.innerHTML = `
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                        </svg>
                        Fechar
                    `;
                } else {
                    form.classList.add('hidden');
                    form.classList.remove('grid');
                    button.innerHTML = `
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Adicionar novo ponto (endereço)
                    `;
                }
            });
            
            // Add point form submission
            document.getElementById('add-point-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('point-name').value;
                const address = document.getElementById('point-address').value;
                const category = document.getElementById('point-category').value;
                
                if (!name || !address) return;
                
                const newPlace = {
                    id: `user-${Date.now()}`,
                    name,
                    category,
                    address,
                    lat: null,
                    lng: null
                };
                
                // Save to localStorage
                const userPlaces = JSON.parse(localStorage.getItem('user:places') || '[]');
                userPlaces.unshift(newPlace);
                localStorage.setItem('user:places', JSON.stringify(userPlaces));
                
                // Add to places and filter
                state.places.unshift(newPlace);
                filterPlaces();
                renderPlacesList();
                addMarkersToMap();
                
                // Reset form
                document.getElementById('point-name').value = '';
                document.getElementById('point-address').value = '';
                document.getElementById('point-category').value = 'Outro';
                
                // Close form
                document.getElementById('add-point-form').classList.add('hidden');
                document.getElementById('add-point-form').classList.remove('grid');
                document.getElementById('toggle-add-form').innerHTML = `
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Adicionar novo ponto (endereço)
                `;
                
                // Try to geocode the address
                geocodePlace(newPlace);
            });
        }

        async function geocodePlace(place) {
            if (place.lat && place.lng) return;
            
            // Show loading state
            state.loadingIds.push(place.id);
            renderPlacesList();
            
            try {
                // Check cache first
                const cacheKey = `geo:${place.address}`;
                const cached = localStorage.getItem(cacheKey);
                
                if (cached) {
                    const { lat, lng } = JSON.parse(cached);
                    updatePlaceCoordinates(place.id, lat, lng);
                    return;
                }
                
                // Geocode using Nominatim
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place.address)}&limit=1&addressdetails=0`;
                const response = await fetch(url, {
                    headers: {
                        'Accept-Language': 'pt-BR,pt;q=0.9'
                    }
                });
                
                const data = await response.json();
                
                if (data && data[0]) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    // Cache result
                    localStorage.setItem(cacheKey, JSON.stringify({ lat, lng }));
                    
                    // Update place
                    updatePlaceCoordinates(place.id, lat, lng);
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            } finally {
                // Remove loading state
                state.loadingIds = state.loadingIds.filter(id => id !== place.id);
                renderPlacesList();
            }
        }

        function updatePlaceCoordinates(id, lat, lng) {
            const placeIndex = state.places.findIndex(p => p.id === id);
            if (placeIndex !== -1) {
                state.places[placeIndex].lat = lat;
                state.places[placeIndex].lng = lng;
                
                // Update filtered places if needed
                const filteredIndex = state.filteredPlaces.findIndex(p => p.id === id);
                if (filteredIndex !== -1) {
                    state.filteredPlaces[filteredIndex].lat = lat;
                    state.filteredPlaces[filteredIndex].lng = lng;
                }
                
                // Update markers
                addMarkersToMap();
                
                // If this is the active place, fly to it
                if (state.activePlace?.id === id) {
                    setActivePlace(state.places[placeIndex]);
                }
            }
        }
    </script>
<p style="border-radius: 8px; text-align: center; font-size: 12px; color: #fff; margin-top: 16px;position: fixed; left: 8px; bottom: 8px; z-index: 10; background: rgba(0, 0, 0, 0.8); padding: 4px 8px;">Made with <img src="https://enzostvs-deepsite.hf.space/logo.svg" alt="DeepSite Logo" style="width: 16px; height: 16px; vertical-align: middle;display:inline-block;margin-right:3px;filter:brightness(0) invert(1);"><a href="https://enzostvs-deepsite.hf.space" style="color: #fff;text-decoration: underline;" target="_blank" >DeepSite</a> - 🧬 <a href="https://enzostvs-deepsite.hf.space?remix=kakaxzz/trabalho-escolar" style="color: #fff;text-decoration: underline;" target="_blank" >Remix</a></p></body>
</html>